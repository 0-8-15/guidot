/* -*-C-*- */

int orbot_is_running()
{
  int rc = -1;
  JNIEnv *env = GetJNIEnv();
  if (env&&globalObj){
    jclass cls = (*env)->FindClass(env, "@SYS_PACKAGE_SLASH@/@SYS_APPNAME@");
    if(cls) {
      jmethodID method = (*env)->GetMethodID(env, cls, "ln_IsOrbotRunning", "()Z");
      if(method) {
        rc = (*env)->CallBooleanMethod(env, globalObj, method);
      }
    }
  }
  return rc;
}

void orbot_ensure_running()
{
  JNIEnv *env = GetJNIEnv();
  if (env&&globalObj){
    jclass cls = (*env)->FindClass(env, "@SYS_PACKAGE_SLASH@/@SYS_APPNAME@");
    jmethodID method = cls ? (*env)->GetMethodID(env, cls, "ensureOrbotRunning", "()V") : NULL;
    if(method) (*env)->CallVoidMethod(env, globalObj, method);
  }
}

const char *android_app_class() { return "@SYS_PACKAGE_DOT@.@SYS_APPNAME@"; } // for jscheme

const char *jscheme_eval(const char *input)
{
  static const char *str = NULL;
  static jstring jstr = NULL;
  JNIEnv *env = GetJNIEnv();
  if (env&&globalObj){
    jstring jin = (*env)->NewStringUTF(env,input);
    jclass main_class = (*env)->FindClass(env, "@SYS_PACKAGE_SLASH@/@SYS_APPNAME@");
    jmethodID method = main_class ? (*env)->GetMethodID(env, main_class, "jschemeCall", "(Ljava/lang/String;)Ljava/lang/String;") : NULL;
    if(jstr) { (*env)->ReleaseStringUTFChars(env, jstr, str); jstr = NULL; } // works?
    jstr = (jstring) method ? (*env)->CallObjectMethod(env, globalObj, method, jin) : NULL;
    // Is this required??? (*env)->ReleaseStringUTFChars(env, jin, NULL);
    str  = jstr ? (*env)->GetStringUTFChars(env, jstr, 0) : NULL;
    // (*env)->ReleaseStringUTFChars(env, jstr, NULL);  // we do it upon next call
  }
  return str;
}
